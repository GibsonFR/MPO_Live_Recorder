(()=>{var k={windowMs:25e3,lowSplit:52,sustainExtendMs:120,minIOI:40,maxIOI:1e3,defaultBpm:110,smoothTempo:.2,minGapMs:{bass:120,mid:90,treb:80},ranges:{bass:{min:28,max:50},mid:{min:55,max:72},treb:{min:72,max:88}},human:{latency:22,jitter:10,swingDefault:.54,vel:{bass:[58,86],mid:[56,82],treb:[56,82]},restBase:.14}},c={record:!1,path:"\u2014",stats:{frames:0,pb:0,taps:0},players:new Map,dedupe:new Set,midi:{access:null,out:null}};function ct(t){let e=c.players.get(t);return e||(e={t0:null,recStart:null,events:[],active:new Map,seen:0,last:0,analysis:null,accomp:{enabled:!1,role:"bass",prevNote:null,prevDeg:null,refrac:0,active:new Set,tempo:110,rhythm:{swing:.54,grid8:Array(8).fill(0)}},model:{degLog:[],maxLog:64,ngram:new Map,pcCooldown:new Array(12).fill(0)},vis:{pcw:new Array(12).fill(0),lastOuts:[],lastDeg:null,planned:[]}},c.players.set(t,e),e)}function B(t,e){let n=0,o=0,r=0,s=0,a=!1,p=l=>{let d=l.touches?l.touches[0]:l;a=!0,n=d.clientX,o=d.clientY;let f=t.getBoundingClientRect();r=f.left,s=f.top,document.addEventListener("mousemove",i,{passive:!1}),document.addEventListener("mouseup",u,{passive:!1}),document.addEventListener("touchmove",i,{passive:!1}),document.addEventListener("touchend",u,{passive:!1}),l.preventDefault()},i=l=>{if(!a)return;let d=l.touches?l.touches[0]:l,f=r+(d.clientX-n),y=s+(d.clientY-o);Object.assign(t.style,{left:Math.max(8,Math.min(window.innerWidth-80,f))+"px",top:Math.max(8,Math.min(window.innerHeight-60,y))+"px",right:"auto",bottom:"auto"}),l.preventDefault()},u=()=>{a=!1,document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",u),document.removeEventListener("touchmove",i),document.removeEventListener("touchend",u)};e.style.cursor="move",e.addEventListener("mousedown",p,{passive:!1}),e.addEventListener("touchstart",p,{passive:!1})}function $(t,e,n){if(!t||!e)return;let o=document.createElement("button");o.type="button",o.title="Minimize",o.setAttribute("aria-label","Minimize panel"),o.textContent="\u2013",o.style.cssText="margin-left:8px;background:#2b2b2b;color:#eee;border:1px solid #444;padding:4px 8px;border-radius:8px;cursor:pointer";let r=t.querySelector(":scope > .__body");if(!r){r=document.createElement("div"),r.className="__body";let i=[],u=e.nextSibling;for(;u;){let l=u.nextSibling;i.push(u),u=l}i.forEach(l=>r.appendChild(l)),t.appendChild(r)}let s="mo:min:"+n;function a(i){r.style.display=i?"none":"",o.textContent=i?"+":"\u2013";try{localStorage.setItem(s,i?"1":"0")}catch{}}let p=!1;try{p=localStorage.getItem(s)==="1"}catch{}return a(p),o.addEventListener("click",()=>a(r.style.display!=="none")),e.appendChild(o),{button:o}}var Y=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],Q=(t,e,n)=>t<e?e:t>n?n:t,C=t=>(t%12+12)%12,R=()=>Date.now();function Gt(t){let e=[],n=t&127;for(e.unshift(n);t>>=7;)n=t&127|128,e.unshift(n);return e}var Qt=t=>Array.from(new TextEncoder().encode(String(t||""))),Jt=t=>Math.max(0,Math.round(t/1e3*(480*2)));function lt(t,e){if(!t.length)return null;let n={on:0,cc:1,off:2},o=t.slice().sort((d,f)=>d.t===f.t?n[d.type]-n[f.type]:d.t-f.t),r=[],s=d=>{let f=Gt(d);for(let y=0;y<f.length;y++)r.push(f[y])},a=(d,f,y)=>{s(d),r.push(255,f,y.length,...y)};a(0,3,Qt(e||"player")),a(0,81,[7,161,32]);let p=0;for(let d of o){let f=Jt(d.t),y=Math.max(0,f-p);p=f,s(y),d.type==="on"?r.push(144,d.note&127,Q(Math.round((d.vel??1)*127),1,127)):d.type==="off"?r.push(128,d.note&127,0):d.type==="cc"&&r.push(176,(d.cc|0)&127,Q(d.val|0,0,127))}s(0),r.push(255,47,0);let i=r.length,u=[77,84,114,107,i>>>24&255,i>>>16&255,i>>>8&255,i&255],l=[77,84,104,100,0,0,0,6,0,0,0,1,1,224];return new Blob([new Uint8Array(l),new Uint8Array(u),new Uint8Array(r)],{type:"audio/midi"})}function pt(t,e){let n=document.createElement("a");n.href=URL.createObjectURL(t),n.download=e,document.body.appendChild(n),n.click(),setTimeout(()=>{URL.revokeObjectURL(n.href),n.remove()},2e3)}function dt(t){return navigator.requestMIDIAccess?navigator.requestMIDIAccess({sysex:!1}).then(e=>(c.midi.access=e,e.onstatechange=()=>t&&t(),e)):Promise.reject(new Error("no-webmidi"))}function ut(){let t=[],e=c.midi.access;if(!e)return t;try{e.outputs.forEach(n=>t.push(n))}catch{let n=e.outputs&&e.outputs.values&&e.outputs.values();if(n)for(let o of n)t.push(o)}return t}function X(t){let e=c.midi.access;if(!e)return null;let n=e.outputs.get?e.outputs.get(t):null;if(!n)try{e.outputs.forEach(o=>{o.id===t&&(n=o)})}catch{}return c.midi.out=n||null,c.midi.out}function Z(t){return t?(t.manufacturer?t.manufacturer+" ":"")+(t.name||t.id||"(unnamed)"):"(none)"}function mt(t,e){let n=c.midi.out;n&&n.send([144,(t|0)&127,Q(Math.round((e??1)*127),1,127)])}function J(t){let e=c.midi.out;e&&e.send([128,(t|0)&127,0])}function ft(){let t=c.midi.out;if(t)for(let e=0;e<128;e++)t.send([128,e&127,0])}function ht(t){let e=c.midi.out;e&&e.send([176,64,t?127:0])}var gt=typeof TextDecoder<"u"?new TextDecoder:null,Kt=(t,e)=>{for(let n of e)if(Array.isArray(t?.[n]))return t[n];return null},z=t=>t.playerId??t.player??t.pid??t.id,W=t=>Kt(t,["events","evts","e"]);function Yt(t){let e=[],n=0;for(;n<t.length;){if(t.charAt(n)==="4"&&t.charAt(n+1)==="2"){let o=n+2;for(;o<t.length&&t.charAt(o)!=="[";)o++;if(o>=t.length)break;let r=0,s=o;for(;s<t.length;s++){let a=t.charAt(s);if(a==="[")r++;else if(a==="]"&&(r--,r===0)){s++;break}}try{e.push(JSON.parse(t.slice(o,s)))}catch{}n=s;continue}n++}return e}function P(t){let e=[];try{if(Array.isArray(t)){if(t[0]==="pianoBatch"){let n=t[1];if(Array.isArray(n))n.forEach(o=>{let r=z(o),s=W(o);r&&s&&e.push({playerId:r,events:s,t:o.t??o.ts??o.tISO??null})});else if(n&&typeof n=="object"){let o=z(n),r=W(n);o&&r&&e.push({playerId:o,events:r,t:n.t??n.ts??n.tISO??null})}}}else if(t&&typeof t=="object"){let n=z(t),o=W(t);if(n&&o)return e.push({playerId:n,events:o,t:t.t??t.ts??t.tISO??null}),e;let r=t.type||t.evt||t.op||t.event,s=t.payload??t.data;if(r==="pianoBatch"){if(Array.isArray(s))s.forEach(a=>{let p=z(a),i=W(a);p&&i&&e.push({playerId:p,events:i,t:a.t??a.ts??a.tISO??null})});else if(s&&typeof s=="object"){let a=z(s),p=W(s);a&&p&&e.push({playerId:a,events:p,t:s.t??s.ts??s.tISO??null})}}else{let a=z(t),p=W(t);a&&p&&e.push({playerId:a,events:p,t:t.t??t.ts??t.tISO??null})}}}catch{}return e}function Xt(t){let e=[];if(!Array.isArray(t))return e;for(let n of t){let o=String(n.name||n.n||"").toUpperCase(),r=(n.timestamp??n.ts??n.time??n.tms??0)|0;if(o==="SUSTAIN"||o.includes("SUSTAIN")||n.cc===64||n.control===64){let s=n.sustain===!0?127:Number.isFinite(n.value)?n.value>=64?127:0:Number.isFinite(n.v)?n.v>=64?127:0:127;e.push({type:"cc",cc:64,val:s,ts:r});continue}if(o==="NOTE_ON"||o==="ON"||n.on===1||n.down===!0){let s=(n.note??n.n??n.k??n.key)|0;if(s<0||s>127)continue;let a=((n.velocity??n.v??n.vel??127)|0)/127;e.push({type:"on",note:s,vel:a,ts:r});continue}if(o==="NOTE_OFF"||o==="OFF"||n.off===1||n.up===!0){let s=(n.note??n.n??n.k??n.key)|0;if(s<0||s>127)continue;e.push({type:"off",note:s,ts:r});continue}}return e}function Zt(t){let e=Array.isArray(t.events)?t.events:[],n=1/0,o=-1/0;for(let a of e){let p=(a.timestamp??a.ts??a.tms??a.time??0)|0;p<n&&(n=p),p>o&&(o=p)}let r=t.playerId??t.player??t.pid??t.id??"?",s=e.length|0;return`${r}|${t.t||t.ts||t.tISO||"?"}|${s}|${n}-${o}`}function Pt(t,e,n,o){t.t0==null&&(t.t0=e),c.record&&t.recStart==null&&(t.recStart=e);let r=t.recStart??t.t0,s=Math.max(0,e-r);if(t.active.has(n)){let a=Math.max(0,s-.1);t.events.push({t:a,type:"off",note:n,vel:0})}t.active.set(n,{tOn:s,vel:o}),t.events.push({t:s,type:"on",note:n,vel:o})}function te(t,e,n){t.t0==null&&(t.t0=e);let o=t.recStart??t.t0,r=Math.max(0,e-o);t.active.has(n)&&t.active.delete(n),t.events.push({t:r,type:"off",note:n,vel:0})}function H(t){if(c.stats.frames++,typeof t=="string"){let e=Yt(t);if(e.length){for(let o of e){let r=P(o);for(let s of r)tt(s,"WS")}return}try{let o=JSON.parse(t),r=Array.isArray(o)?o:[o];for(let s of r){let a=P(s);for(let p of a)tt(p,"WS")}return}catch{}let n=t.split(/\r?\n/).map(o=>o.trim()).filter(Boolean);for(let o of n)try{let r=JSON.parse(o),s=P(r);for(let a of s)tt(a,"WS")}catch{}return}if(t instanceof ArrayBuffer){if(gt)try{let e=gt.decode(new Uint8Array(t));e&&H(e)}catch{}return}if(typeof Blob<"u"&&t instanceof Blob){let e=new FileReader;e.onload=function(){H(String(e.result||""))};try{e.readAsText(t.slice(0,16384))}catch{}}}function tt(t,e){c.path=e||c.path;let n=Zt(t);if(c.dedupe.has(n))return;c.dedupe.add(n);let o=String(t.playerId??t.player??t.pid??t.id??"unknown"),r=ct(o),s=Xt(t.events);if(!s.length)return;let a=t.t!=null?t.t:null,p=s[0].ts;for(let i of s){let u=a!=null?a-p+i.ts:R()+(i.ts-p);if(i.type==="cc"&&i.cc===64){r.t0==null&&(r.t0=u),c.record&&r.recStart==null&&(r.recStart=u);let l=r.recStart??r.t0,d=Math.max(0,u-l);r.events.push({t:d,type:"cc",cc:64,val:i.val|0});continue}if(i.type==="on"){Pt(r,u,i.note,i.vel);continue}if(i.type==="off"){te(r,u,i.note);continue}}r.seen+=s.length,r.last=R(),c.stats.pb++}function xt(){let t=window.WebSocket;if(t){if(!t.prototype.__mo_hooked__){let e=t.prototype.addEventListener;t.prototype.addEventListener=function(r,s,a){if(r==="message"&&typeof s=="function"){let p=i=>{try{c.stats.taps++,H(i.data)}catch{}return s.call(this,i)};return e.call(this,r,p,a)}return e.call(this,r,s,a)};let n=Object.getOwnPropertyDescriptor(t.prototype,"onmessage")||{};Object.defineProperty(t.prototype,"onmessage",{configurable:!0,enumerable:!0,get:n.get?n.get:function(){return this.__mo_on__||null},set:function(r){if(typeof r=="function"){let s=a=>{try{c.stats.taps++,H(a.data)}catch{}return r.call(this,a)};this.__mo_on__=s,this.addEventListener("message",s)}else this.__mo_on__=null}});let o=t.prototype.send;t.prototype.send=function(){try{this.__mo_attached__||(this.addEventListener("message",r=>{try{c.stats.taps++,H(r.data)}catch{}}),Object.defineProperty(this,"__mo_attached__",{value:!0}))}catch{}return o.apply(this,arguments)},Object.defineProperty(t.prototype,"__mo_hooked__",{value:!0})}if(!window.__mo_ws_ctor__){let e=function(n,o){let r=o!==void 0?new t(n,o):new t(n);try{r.addEventListener("message",s=>{try{c.stats.taps++,H(s.data)}catch{}}),Object.defineProperty(r,"__mo_attached__",{value:!0})}catch{}return r};e.prototype=t.prototype,Object.setPrototypeOf(e,t),window.WebSocket=e,Object.defineProperty(window,"__mo_ws_ctor__",{value:!0})}}}function yt(){let t=document.createElement("div");Object.assign(t.style,{position:"fixed",right:"12px",top:"12px",zIndex:999999,minWidth:"420px",color:"#eee",fontFamily:"system-ui",background:"rgba(17,17,17,.95)",borderRadius:"10px",boxShadow:"0 10px 30px rgba(0,0,0,.6)",maxHeight:"70vh",overflow:"hidden"}),t.innerHTML=`
    <style>
      .mo-btn{background:#2b2b2b;color:#eee;border:1px solid #444;padding:6px 10px;border-radius:8px;user-select:none}
      .mo-btn:hover{background:#353535}
      .mo-chip{background:#1b1b1b;padding:3px 8px;border-radius:10px}
      .row{display:flex;gap:8px;align-items:center;margin-bottom:6px;flex-wrap:wrap;min-height:34px}
      .row-live{outline:2px solid #1a915e;border-radius:10px;background:linear-gradient(90deg, rgba(26,145,94,0.12), transparent)}
    </style>
    <div id="hdr" style="display:flex;align-items:center;gap:8px;user-select:none;cursor:move">
      <strong>Room Recorder</strong>
      <span id="st" class="mo-chip" style="margin-left:auto;background:#264a2f">live</span>
    </div>
    <div style="display:flex;gap:6px;margin-top:8px;align-items:center;flex-wrap:wrap">
      <button id="expAll" class="mo-btn">Export all</button>
      <button id="clear" class="mo-btn">Clear</button>
    </div>
    <div style="margin-top:6px;font-size:12px;opacity:.85">
      frames:<b id="f">0</b> \u2022 pb:<b id="pb">0</b> \u2022 taps:<b id="t">0</b> \u2022 path:<b id="path">\u2014</b>
    </div>
    <div id="players" style="margin-top:8px;border:1px solid #333;border-radius:8px;padding:6px;max-height:48vh;overflow:auto;font-size:12px"></div>
  `,document.body.appendChild(t);let e=t.querySelector("#hdr")||t.firstElementChild;$(t,e,"recorder"),B(t,e);let n=t.querySelector("#expAll"),o=t.querySelector("#clear"),r=t.querySelector("#f"),s=t.querySelector("#pb"),a=t.querySelector("#t"),p=t.querySelector("#path"),i=t.querySelector("#players"),u=new Map;function l(){r.textContent=String(c.stats.frames),s.textContent=String(c.stats.pb),a.textContent=String(c.stats.taps),p.textContent=c.path}function d(h){let m=u.get(h);if(m)return m;let x=document.createElement("div");x.className="row",x.setAttribute("data-id",h),x.innerHTML=`
      <code style="background:#111;padding:2px 6px;border-radius:6px">${h}</code>
      <span class="seen">seen:0</span>
      <span class="ev">\u2022 ev:0</span>
      <span class="act">\u2022 act:0</span>
      <span class="last">\u2022 last:\u2014s</span>
      <span class="an mo-chip" style="margin-left:auto;opacity:.9">\u2014</span>
      <div class="btns" style="display:flex;gap:6px;margin-left:auto">
        <button class="mo-btn save">Export</button>
        <button class="mo-btn reset">Reset</button>
      </div>`;let w={row:x,seen:x.querySelector(".seen"),ev:x.querySelector(".ev"),act:x.querySelector(".act"),last:x.querySelector(".last"),an:x.querySelector(".an"),save:x.querySelector(".save"),reset:x.querySelector(".reset")};return i.appendChild(x),u.set(h,w),w.save.onclick=()=>y(h),w.reset.onclick=()=>{let M=c.players.get(h);M&&(M.events.length=0,M.active.forEach((S,_)=>J(_)),M.active.clear(),M._lastOnIdx=0,M.vis.lastOuts=[],f(h,M))},w}function f(h,m){let x=d(h);x.seen.textContent=`seen:${m.seen}`,x.ev.textContent=`\u2022 ev:${m.events.length}`,x.act.textContent=`\u2022 act:${m.active.size}`,x.last.textContent=`\u2022 last:${m.last?((R()-m.last)/1e3).toFixed(1)+"s":"\u2014s"}`;let w="\u2014";if(m.analysis){let{bpm:M,swing:S,scale:_,rootPc:q}=m.analysis;w=`${Math.round(M)}bpm \u2022 sw:${S.toFixed(2)} \u2022 key:${_}/${q}`}x.an.textContent=w,x.row.classList.toggle("row-live",R()-m.last<800)}function y(h){let m=c.players.get(h);if(!m||!m.events.length)return;let x=lt(m.events);pt(x,`player-${h}-${Date.now()}.mid`)}return n.onclick=()=>{c.players.forEach((h,m)=>y(m))},o.onclick=()=>{ht(!1),ft(),c.players.clear(),c.dedupe.clear(),i.innerHTML="",u.clear()},setInterval(()=>{c.players.forEach((h,m)=>f(m,h)),n.disabled=[...c.players.values()].every(h=>!h.events.length&&!h.active.size),l()},400),{box:t}}var ee=[6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88],ne=[6.33,2.68,3.52,5.38,2.6,3.53,2.54,4.75,3.98,2.69,3.34,3.17];function bt(t,e){let n=t.length,o=new Array(n);for(let r=0;r<n;r++)o[(r+e)%n]=t[r];return o}function Mt(t,e){let n=0;for(let o=0;o<t.length;o++)n+=t[o]*e[o];return n}function vt(t){return Math.sqrt(Mt(t,t))}function wt(t,e){let n=vt(t),o=vt(e);return n===0||o===0?0:Mt(t,e)/(n*o)}function St(t){let e=(t?.events||[]).filter(r=>r.type!=="cc");if(!k.windowMs||!e.length)return e;let n=e[e.length-1].t|0,o=Math.max(0,n-k.windowMs);return e.filter(r=>r.t>=o)}function oe(t,e){let n=St(t);if(!n.length)return new Array(12).fill(0);let o=new Map,r=new Map,s=!1,a=(t?.events||[]).filter(i=>i.type==="cc"&&i.cc===64);if(a.length){let i=a[a.length-1];(t.t0!=null?t.t0+i.t:R())>e-400&&(s=i.val>=64)}for(let i of n)if(i.type==="on")o.set(i.note,i.t);else if(i.type==="off"){let u=o.get(i.note);if(u!=null){let l=i.t-u;r.set(i.note,(r.get(i.note)||0)+Math.max(10,l)),o.delete(i.note)}}o.forEach((i,u)=>{let l=s?k.sustainExtendMs:30,d=Math.max(10,n[n.length-1].t-i+l);r.set(u,(r.get(u)||0)+d)});let p=new Array(12).fill(0);return r.forEach((i,u)=>{let l=t.active?.get(u)?.vel||.7,d=u<=k.lowSplit?1.8:1;p[C(u)]+=i*d*(.6+.6*l)}),p}function re(t){let e={type:"maj",root:0,c:-1};for(let r=0;r<12;r++){let s=wt(t,bt(ee,r)),a=wt(t,bt(ne,r));s>e.c&&(e={type:"maj",root:r,c:s}),a>e.c&&(e={type:"min",root:r,c:a})}let n=e.type==="min",o=(n?[0,2,3,5,7,8,10]:[0,2,4,5,7,9,11]).map(r=>C(r+e.root));return{rootPc:e.root,isMinor:n,scale:o,conf:e.c}}function se(t,e,n){let o=t.filter(h=>h.type==="on").map(h=>h.t).sort((h,m)=>h-m);if(o.length<6)return{bpm:e||k.defaultBpm,swing:n??k.human.swingDefault};let r=[];for(let h=1;h<o.length;h++){let m=o[h]-o[h-1];m>k.minIOI&&m<k.maxIOI&&r.push(m)}if(!r.length)return{bpm:e||k.defaultBpm,swing:n??k.human.swingDefault};let s=r.slice().sort((h,m)=>h-m),a=s[s.length/2|0],p=6e4/Math.max(120,Math.min(900,a));p<55&&(p*=2),p>170&&(p/=2),e&&(p=e*(1-k.smoothTempo)+p*k.smoothTempo);let u=6e4/Math.max(40,Math.min(220,p))/2,l=o.map(h=>h/u%2),d=0,f=0;for(let h of l){let m=h%2,x=Math.abs(m-1),w=Math.min(m,2-m);x<w&&(d+=1-x,f++)}let y=n??k.human.swingDefault;if(f>0){let h=d/f,m=.5+Math.min(.16,h*.22);y=y*.8+m*.2}return{bpm:p,swing:Math.max(.5,Math.min(.7,y))}}function ae(t,e,n){let o=6e4/Math.max(40,Math.min(220,e)),r=o/2*n,s=o/2*(2-2*n),a=[],p=0;for(let f=0;f<8;f++)a.push({i:f,t:p}),p+=f%2?s:r;let i=new Array(8).fill(0),u=t.filter(f=>f.type==="on").map(f=>f.t),l=a[7].t+(7%2?s:r);for(let f of u){let y=(f%l+l)%l,h=0,m=1e9;for(let w of a){let M=Math.abs(y-w.t);M<m&&(m=M,h=w.i)}let x=Math.max(.1,1-m/(o*.5));i[h]+=x}let d=Math.max(1,...i);return i.map(f=>f/d)}function _t(t){let e=performance.now?performance.now():Date.now(),n=St(t),o=oe(t,e),{bpm:r,swing:s}=se(n,t.analysis?.bpm,t.analysis?.swing),a=re(o),p=t.analysis?.rootPc??a.rootPc,i=.25,u=(Math.round(p*(1-i)+a.rootPc*i)%12+12)%12,l=o.reduce((f,y)=>f+y,0)||1,d=o.map(f=>f/l);return t.analysis={bpm:r,swing:s,rootPc:u,isMinor:a.isMinor,scale:a.scale,conf:a.conf},t.vis=t.vis||{},t.vis.pcw=d,t.vis.grid8=ae(n,r,s),t.analysis}function kt(t){return k?.ranges?.[t]||k?.ranges?.bass||{min:36,max:84}}function At(t){return k?.minGapMs?.[t]||120}function Ot(t){let e=Math.max(0,Math.min(1,t));return Math.min(.85,1/(1+Math.exp(-8*(e-.45))))}function D(t,e={}){try{let n=c&&c.__logPush;typeof n=="function"&&n(t,e)}catch{}}function ie(t,e,n){let o=n??60-C(60)+t,r=Math.round((e.min+e.max)/2);for(n==null&&(o=r-C(r)+t);o<e.min;)o+=12;for(;o>e.max;)o-=12;return o}function et(t,e,n,o){let r=null,s=-1e9;for(let a=0;a<e.length;a++){let p=e[a],i=ie(p,o,t),u=i+12<=o.max?i+12:i,l=i-12>=o.min?i-12:i;for(let d of[i,u,l]){let f=t==null?0:Math.abs(d-t),y=-.015*Math.abs(d-(o.min+o.max)/2),h=-.9*f,x=1*Math.log(1+(n[a]||1))+h+y+(Math.random()*.5-.25);x>s&&(s=x,r=d)}}return r}function Et(){let t=c?.accompOpts?.humanize;return t??k?.human?.jitter??7}function nt(t,e,n,o,r,s){if(!c?.midi?.out){D("emit.skip.no_midi",{note:e,vel:n,durMs:o,delayMs:r,meta:s});return}let p=Math.random()*2*Et()-Et(),i=Math.max(0,(r??0)+(k?.human?.latency||0)+p),u=performance.now?performance.now():Date.now();setTimeout(()=>{try{mt(e,Math.round(n*127))}catch{}t.accomp.active.add(e),t.vis=t.vis||{},t.vis.lastOuts=t.vis.lastOuts||[],t.vis.lastOuts.push(e),t.vis.lastOuts.length>8&&t.vis.lastOuts.shift(),c.__lastMidiOutAt=performance.now?performance.now():Date.now(),D("emit.note_on",{note:e,vel:n,durMs:o,delayMs:i,meta:s}),setTimeout(()=>{try{J(e)}catch{}t.accomp.active.delete(e),D("emit.note_off",{note:e,meta:s})},Math.max(40,o+(Math.random()*20-10)))},i),D("emit.scheduled",{at:u+i,note:e,vel:n,durMs:o,meta:s})}function ce(t,e,n,o,r,s){let a=[];for(let i=0;i<e.length;i++){let u=et(t.accomp.prevChord?.[i]??t.accomp.prevNote,[e[i]],[1],n);a.push(u)}t.accomp.prevChord=a.slice();let p=[...new Set(a)];D("emit.chord",{voiced:p,holdMs:r,meta:s});for(let i of p)nt(t,i,o,r,0,s)}function It(t){t.accomp=t.accomp||{},t.accomp.prevNote=null,t.accomp.prevChord=null,t.accomp.active=new Set,t.accomp.phaseT0=null,t.accomp.lastSlot=-1,t.accomp.measureNotes=0,t.accomp.__lastEmitAt=0,D("accomp.init",{playerId:t.id??null})}function le(t,e){let n=6e4/Math.max(40,Math.min(220,t)),o=n/2,r=o*e,s=o*(2-2*e),a=[r,s,r,s,r,s,r,s],p=a.reduce((l,d)=>l+d,0),i=[],u=0;for(let l=0;l<8;l++)i.push(u),u+=a[l];return{beat:n,slotDur:a,barLen:p,cum:i}}function pe(t,e){for(let n=7;n>=0;n--)if(t>=e[n])return n;return 0}function Dt(t,e){if(!e){D("tick.skip.no_player");return}let n=c&&c.accompOpts?c.accompOpts:{enabled:!1,role:"pads"};if(!n.enabled){D("tick.skip.disabled");return}if(!c?.midi?.out){D("tick.skip.no_midi");return}let r=n.role||"pads",s=Math.max(40,Math.min(220,e.analysis?.bpm||k?.defaultBpm||110)),a=e.analysis?.swing??k?.human?.swingDefault??.58,{beat:p,slotDur:i,barLen:u,cum:l}=le(s,a),d=performance.now?performance.now():Date.now();e.accomp.phaseT0==null&&(e.accomp.phaseT0=d,e.accomp.lastSlot=-1,e.accomp.measureNotes=0,D("clock.anchor",{t0:e.accomp.phaseT0,bpm:s,swing:a,barLen:u,slotDur:i}));let f=(d-e.accomp.phaseT0)%u;f<0&&(f+=u);let y=pe(f,l);if(y===e.accomp.lastSlot){D("tick.same_slot",{slot:y});return}y===0&&e.accomp.lastSlot!==-1&&(e.accomp.measureNotes=0,D("clock.new_bar")),e.accomp.lastSlot=y;let m=(e.vis?.grid8||new Array(8).fill(0))[y]||0,x=Ot(m),w=Math.max(.18,x);if(e.accomp.measureNotes>=2){D("gate.measure_limit",{slot:y});return}if(Math.random()<.25){D("gate.rest",{slot:y});return}if(Math.random()>w){D("gate.prob",{slot:y,prob:w,dens:m});return}let M=Math.max(At(r),i[y]*.8);if(d-e.accomp.__lastEmitAt<M){D("gate.refractory",{slot:y,since:d-e.accomp.__lastEmitAt,needed:M});return}let S=kt(r),_=e.analysis?.rootPc??0,q=!!e.analysis?.isMinor,b=r==="pads"?.7:r==="bass"?.8:.65,g={role:r,slot:y,bpm:s,swing:a,rootPc:_,isMinor:q};if(r==="bass"){let A=Math.random()<.25?7:0,O=[C(_+A)],N=et(e.accomp.prevNote,O,[1],S),F=Math.min(p*.95,520),v=y%2===0&&Math.random()<.3?-Math.min(40,i[y]*.25):0;D("emit.plan.bass",{note:N,hold:F,lead:v,range:S,...g}),nt(e,N,b,F,v,g),e.accomp.prevNote=N,e.accomp.measureNotes++}else if(r==="arps"){let A=q?[_,C(_+3),C(_+7)]:[_,C(_+4),C(_+7)],O=et(e.accomp.prevNote,A,[1,1,1],S);D("emit.plan.arp",{note:O,range:S,...g}),nt(e,O,b,Math.min(p*.5,300),0,g),e.accomp.prevNote=O,e.accomp.measureNotes++}else{let A=q?[_,C(_+3),C(_+7)]:[_,C(_+4),C(_+7)];D("emit.plan.pad",{tri:A,range:S,hold:Math.min(p*1.5,900),...g}),ce(e,A,S,b,Math.min(p*1.5,900),g),e.accomp.measureNotes++}e.accomp.__lastEmitAt=d}typeof c!="object"&&(window.AppState={});var Tt;(Tt=c).players??(Tt.players=new Map);var Lt;(Lt=c).midi??(Lt.midi={out:null});var Nt;(Nt=c).accompOpts??(Nt.accompOpts={enabled:!0,role:"pads",follow:!0,humanize:k?.human?.jitter??7});var Ft;(Ft=c).__logBuffer??(Ft.__logBuffer=[]);var Ut;(Ut=c).__logStartedAt??(Ut.__logStartedAt=performance.now?performance.now():Date.now());var Bt;(Bt=c).__logEnabled??(Bt.__logEnabled=!1);var $t;($t=c).__logAutoDownload??($t.__logAutoDownload={enabled:!1,delaySec:60,t0:0});c.__logPush=(t,e={})=>{if(!c.__logEnabled)return;let o={t:performance.now?performance.now():Date.now(),type:t,...e};c.__logBuffer.push(o),c.__logBuffer.length>2e4&&c.__logBuffer.shift()};function Ct(t=null){let e={startedAt:c.__logStartedAt,now:performance.now?performance.now():Date.now(),events:c.__logBuffer},n=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),o=URL.createObjectURL(n),r=document.createElement("a"),s=new Date().toISOString().replace(/[:.]/g,"-");r.download=t||`mo-live-log-${s}.json`,r.href=o,document.body.appendChild(r),r.click(),setTimeout(()=>{URL.revokeObjectURL(o),document.body.removeChild(r)},0)}function K(){return c?.uiTheme==="dark"||c?.uiTheme!=="light"&&window.matchMedia?.("(prefers-color-scheme: dark)").matches?{bg:"rgba(17,17,17,.96)",fg:"#eee",mid:"#2c2c2c",sub:"#aaa",acc1:"#6fa7ff",acc2:"#9ad5b3"}:{bg:"rgba(250,250,250,.98)",fg:"#111",mid:"#e4e4e4",sub:"#444",acc1:"#2f6fff",acc2:"#1a915e"}}function qt(t,e,n,o){let r=K(),s=t.canvas.width,a=t.canvas.height;t.clearRect(0,0,s,a),t.fillStyle=r.bg,t.fillRect(0,0,s,a);let p=10,i=e.length,u=Math.floor((s-2*p)/i);for(let l=0;l<i;l++){let d=p+l*u;t.fillStyle=r.mid,t.fillRect(d,10,u-4,a-22);let f=Math.round((e[l]||0)*(a-26));t.fillStyle=o,t.fillRect(d,a-12-f,u-4,f),n&&(t.fillStyle=r.sub,t.font="11px system-ui",t.fillText(String(n[l]??""),d+2,a-2))}}function Rt(){let t=K(),e=document.createElement("div");Object.assign(e.style,{position:"fixed",right:"12px",bottom:"12px",zIndex:999999,minWidth:"460px",color:t.fg,fontFamily:"system-ui",background:t.bg,borderRadius:"12px",padding:"10px",boxShadow:"0 10px 30px rgba(0,0,0,.35)",backdropFilter:"blur(6px)"}),e.innerHTML=`
    <div id="hdr" style="display:flex;align-items:center;gap:8px;user-select:none;cursor:move">
      <strong>Live Monitor</strong>
      <span id="midiBadge" style="margin-left:auto;padding:3px 8px;border-radius:10px;border:1px solid ${t.mid}">MIDI: \u2014</span>
    </div>

    <div style="display:flex;gap:6px;margin-top:8px;align-items:center;flex-wrap:wrap">
      <label>Player</label>
      <select id="sel" style="flex:1;min-width:160px;background:transparent;color:${t.fg};border:1px solid ${t.mid};border-radius:8px;padding:6px"></select>
      <label style="display:flex;align-items:center;gap:6px;font-size:12px">
        <input id="acOn" type="checkbox"> Accomp
      </label>
      <select id="role" style="min-width:110px;background:transparent;color:${t.fg};border:1px solid ${t.mid};border-radius:8px;padding:6px">
        <option value="pads">Pads</option>
        <option value="bass">Bass</option>
        <option value="arps">Arps</option>
      </select>
      <label style="display:flex;align-items:center;gap:6px;font-size:12px">
        <input id="follow" type="checkbox" checked> Follow
      </label>
      <button id="test" style="margin-left:auto;border:1px solid ${t.mid};background:transparent;border-radius:8px;padding:6px 10px;color:${t.fg}">Test</button>
    </div>

    <div style="display:flex;gap:10px;margin-top:8px;align-items:center">
      <label style="font-size:12px;width:74px">Humanize</label>
      <input id="human" type="range" min="0" max="25" step="1" style="flex:1" />
      <span id="humanv" style="font-size:12px;width:38px;text-align:right">\u2014</span>
    </div>

    <!-- Scope / fen\xEAtre d'analyse -->
    <div style="display:flex;gap:10px;margin-top:6px;align-items:center">
      <label style="font-size:12px;width:74px">Scope</label>
      <input id="scope" type="range" min="2000" max="20000" step="1000" style="flex:1" />
      <span id="scopev" style="font-size:12px;width:48px;text-align:right">\u2014</span>
    </div>

    <div id="statline" style="margin-top:6px;font-size:12px;opacity:.9">\u2014</div>
    <div style="margin-top:8px"><canvas id="pc"   width="440" height="82" style="background:transparent;border:1px solid ${t.mid};border-radius:8px"></canvas></div>
    <div style="margin-top:8px"><canvas id="grid" width="440" height="82" style="background:transparent;border:1px solid ${t.mid};border-radius:8px"></canvas></div>

    <div style="margin-top:10px;border-top:1px solid ${t.mid};padding-top:8px">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <strong style="font-size:12px">Logging</strong>
        <label style="display:flex;align-items:center;gap:6px;font-size:12px">
          <input id="logOn" type="checkbox"> Enable
        </label>
        <span id="logCount" style="font-size:12px;opacity:.9">events: 0</span>
        <button id="logDl" style="border:1px solid ${t.mid};background:transparent;border-radius:8px;padding:6px 10px;color:${t.fg}">Download JSON</button>
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;margin-left:auto">
          <input id="autoDl" type="checkbox"> Auto-download
        </label>
        <input id="autoDelay" type="number" min="5" max="600" value="60" style="width:68px;background:transparent;color:${t.fg};border:1px solid ${t.mid};border-radius:6px;padding:4px 6px" />
        <span id="autoLeft" style="font-size:12px;opacity:.8">\u2014</span>
      </div>
    </div>
  `,document.body.appendChild(e);let n=e.querySelector("#hdr")||e.firstElementChild;$(e,n,"monitor"),B(e,n);let o=e.querySelector("#sel"),r=e.querySelector("#acOn"),s=e.querySelector("#role"),a=e.querySelector("#follow"),p=e.querySelector("#human"),i=e.querySelector("#humanv"),u=e.querySelector("#scope"),l=e.querySelector("#scopev"),d=e.querySelector("#statline"),f=e.querySelector("#pc").getContext("2d"),y=e.querySelector("#grid").getContext("2d"),h=e.querySelector("#test"),m=e.querySelector("#midiBadge"),x=e.querySelector("#logOn"),w=e.querySelector("#logDl"),M=e.querySelector("#logCount"),S=e.querySelector("#autoDl"),_=e.querySelector("#autoDelay"),q=e.querySelector("#autoLeft");r.checked=!!c.accompOpts?.enabled,s.value=c.accompOpts?.role||"pads",a.checked=c.accompOpts?.follow??!0,p.value=String(c.accompOpts?.humanize??k?.human?.jitter??7),i.textContent=p.value,u.value=String(k?.windowMs??12e3),l.textContent=`${Math.round(Number(u.value)/1e3)}s`,x.checked=!!c.__logEnabled,S.checked=!!c.__logAutoDownload.enabled,_.value=String(c.__logAutoDownload.delaySec??60),r.onchange=()=>{var v;(v=c).accompOpts??(v.accompOpts={}),c.accompOpts.enabled=r.checked},s.onchange=()=>{var v;(v=c).accompOpts??(v.accompOpts={}),c.accompOpts.role=s.value},a.onchange=()=>{var v;(v=c).accompOpts??(v.accompOpts={}),c.accompOpts.follow=a.checked},p.oninput=()=>{var v;(v=c).accompOpts??(v.accompOpts={}),c.accompOpts.humanize=Number(p.value),i.textContent=p.value},u.oninput=()=>{let v=Math.max(2e3,Math.min(2e4,Number(u.value)||12e3));k&&(k.windowMs=v),l.textContent=`${Math.round(v/1e3)}s`},x.onchange=()=>{c.__logEnabled=x.checked,x.checked&&(c.__logBuffer=[],c.__logStartedAt=performance.now?performance.now():Date.now())},w.onclick=()=>Ct(),S.onchange=()=>{c.__logAutoDownload.enabled=S.checked,c.__logAutoDownload.t0=performance.now?performance.now():Date.now(),c.__logAutoDownload.delaySec=Math.max(5,Math.min(600,Number(_.value)||60))},_.oninput=()=>{c.__logAutoDownload.delaySec=Math.max(5,Math.min(600,Number(_.value)||60))},h.onclick=()=>{let v=c?.midi?.out;if(!v){alert("Aucune sortie MIDI d\xE9tect\xE9e.");return}let I=performance.now?performance.now():Date.now();c.__lastMidiOutAt=I;let E=60;try{v.send([144,E,100]),v.send([144,E+4,100]),v.send([144,E+7,100]),setTimeout(()=>{try{v.send([128,E,0]),v.send([128,E+4,0]),v.send([128,E+7,0])}catch{}},450)}catch{}};function b(){let v=o.value;o.innerHTML="";let I=[...c.players.keys()];for(let E of I){let U=document.createElement("option");U.value=E,U.textContent=String(E),o.appendChild(U)}I.length&&(o.value=I.includes(v)?v:I[0])}setInterval(b,900);function g(){if(!a.checked)return o.value;let v=null,I=-1e9,E=performance.now?performance.now():Date.now();return c.players.forEach((U,V)=>{let G=(U.events||[]).filter(Vt=>Vt.type!=="cc"),it=-(G.length?E-G[G.length-1].t:1e9)+G.length*10;it>I&&(I=it,v=V)}),v??o.value}function A(v){v.accomp||It(v)}function O(){let v=c?.midi?.out||null,I=c?.__lastMidiOutAt||0,U=(performance.now?performance.now():Date.now())-I;if(m){if(!v){m.textContent="MIDI: none",m.style.opacity=.7;return}m.textContent=U<2e3?"MIDI: active":"MIDI: idle",m.style.opacity=1}}function N(){if(M.textContent=`events: ${c.__logBuffer.length}`,c.__logAutoDownload.enabled){let v=performance.now?performance.now():Date.now(),I=(v-(c.__logAutoDownload.t0||v))/1e3,E=Math.max(0,Math.ceil((c.__logAutoDownload.delaySec||60)-I));q.textContent=E?`auto in ${E}s`:"downloading\u2026",E===0&&(c.__logAutoDownload.enabled=!1,S.checked=!1,Ct())}else q.textContent="\u2014"}function F(){O(),N();let v=g()||[...c.players.keys()][0];v&&o.value!==v&&a.checked&&(o.value=v);let I=c.players.get(v);if(I){let E=_t(I);A(I),qt(f,I.vis.pcw,Array.from({length:12},(U,V)=>Y[V]),K().acc1),qt(y,I.vis.grid8,Array.from({length:8},(U,V)=>V+1),K().acc2),d.textContent=`${Math.round(E.bpm)} bpm \u2022 swing ${(E.swing||0).toFixed(2)} \u2022 ${Y[E.rootPc]} ${E.isMinor?"min":"maj"}`,Dt(v,I)}requestAnimationFrame(F)}return requestAnimationFrame(F),e}function ot(t,e){return t.getUint8(e)<<8|t.getUint8(e+1)}function jt(t,e){return t.getUint8(e)<<24|t.getUint8(e+1)<<16|t.getUint8(e+2)<<8|t.getUint8(e+3)}function rt(t,e){let n=0,o=e,r;do r=t.getUint8(o++),n=n<<7|r&127;while(r&128);return{val:n,len:o-e}}function de(t){let e=new DataView(t);if(String.fromCharCode(e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3))!=="MThd")throw new Error("Invalid MIDI");let n=jt(e,4),o=ot(e,8),r=ot(e,10),s=ot(e,12),a=8+n,p=[];for(let i=0;i<r;i++){if(String.fromCharCode(e.getUint8(a),e.getUint8(a+1),e.getUint8(a+2),e.getUint8(a+3))!=="MTrk")throw new Error("Bad track");let u=jt(e,a+4),l=a+8+u,d=a+8,f=0,y=0,h=[];for(;d<l;){let m=rt(e,d);d+=m.len,y+=m.val;let x=e.getUint8(d++);if(x&128?f=x:(d--,x=f),x===255){let w=e.getUint8(d++),M=rt(e,d);d+=M.len;let S=new Uint8Array(t,d,M.val);d+=M.val,h.push({tick:y,type:"meta",meta:w,data:S})}else if(x===240||x===247){let w=rt(e,d);d+=w.len+w.val}else{let w=x&240,M=x&15,S=e.getUint8(d++),_=w===192||w===208?0:e.getUint8(d++);h.push({tick:y,type:w,ch:M,a:S,b:_})}}p.push(h),a=l}return{format:o,division:s,tracks:p}}function ue(t){let e=[];for(let l of t.tracks)for(let d of l)e.push(d);e.sort((l,d)=>l.tick-d.tick);let n=5e5,o=[];for(let l of e)l.type==="meta"&&l.meta===81&&l.data&&l.data.length===3?(n=l.data[0]<<16|l.data[1]<<8|l.data[2],o.push({kind:"tempo",tick:l.tick,tempo:n})):typeof l.type=="number"&&o.push({kind:"midi",tick:l.tick,type:l.type,ch:l.ch,a:l.a,b:l.b});let r=t.division&32767,s=0,a=5e5,p=0,i=[],u=0;for(;u<o.length;){let l=o[u],d=l.tick-s;p+=d*(a/1e6)/r,s=l.tick,l.kind==="tempo"?a=l.tempo:i.push({...l,time:p}),u++}return i}function me(){let t=[],e=!1,n=0,o=0,r=1,s=0,a=0,p=null,i=new Map;function u(){return c.midi.out}function l(){return performance.now()/1e3}function d(b){let g=u();if(g)if(b.type===144)g.send([144|b.ch,b.a+s&127,b.b]),i.set(b.ch<<8|b.a,[b.a+s&127,b.ch]);else if(b.type===128){let A=b.ch<<8|b.a,O=i.get(A)||[b.a+s&127,b.ch];g.send([128|O[1],O[0],0]),i.delete(A)}else b.type===176?g.send([176|b.ch,b.a,b.b]):b.type===192?g.send([192|b.ch,b.a]):b.type===224&&g.send([224|b.ch,b.a,b.b])}function f(){let b=u();if(b)for(let g=0;g<16;g++)b.send([176|g,123,0])}function y(b){e=!1,p&&cancelAnimationFrame(p),f(),o=Math.max(0,Math.min(b,h())),a=t.findIndex(g=>g.time>=o),a<0&&(a=t.length)}function h(){return t.length?t[t.length-1].time:0}function m(b){r=Math.max(.25,Math.min(4,b||1))}function x(b){s=Math.max(-36,Math.min(36,b|0))}function w(){if(!e)return;let b=(l()-n)*r+o;for(;a<t.length&&t[a].time<=b;)d(t[a++]);if(a>=t.length){e=!1,f();return}p=requestAnimationFrame(w)}function M(){e||(e=!0,n=l(),p=requestAnimationFrame(w))}function S(){if(!e)return;let b=(l()-n)*r+o;e=!1,p&&cancelAnimationFrame(p),o=b,f()}function _(){e=!1,p&&cancelAnimationFrame(p),o=0,a=0,f()}function q(b){let g=de(b);return t=ue(g),o=0,a=0,{duration:h()}}return{play:M,pause:S,stop:_,seek:y,setTempoMul:m,setTranspose:x,loadBuffer:q,duration:h,isPlaying:()=>e,currentTime:()=>e?(performance.now()/1e3-n)*r+o:o}}function zt(){let t=document.createElement("div");Object.assign(t.style,{position:"fixed",left:"12px",top:"12px",zIndex:999999,background:"rgba(17,17,17,.95)",color:"#eee",padding:"10px",borderRadius:"10px",fontFamily:"system-ui",minWidth:"420px",maxWidth:"520px",boxShadow:"0 10px 30px rgba(0,0,0,.6)"}),t.innerHTML=`
    <style>
      .mo-btn{background:#2b2b2b;color:#eee;border:1px solid #444;padding:6px 10px;border-radius:8px;user-select:none;cursor:pointer}
      .mo-btn:hover{background:#353535}
      .mo-chip{background:#1b1b1b;padding:3px 8px;border-radius:10px}
      .mo-input{background:#1b1b1b;color:#eee;border:1px solid #333;border-radius:8px;padding:6px}
      .mo-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
      .mo-col{display:flex;flex-direction:column;gap:4px}
      #drop{border:1px dashed #555;padding:12px;border-radius:8px;text-align:center;opacity:.9}
      #drop.drag{background:#202020}
      #filelist{max-height:140px;overflow:auto;border:1px solid #333;border-radius:8px;padding:6px}
      #seek{width:100%}
      #hdr{display:flex;align-items:center;gap:8px;user-select:none}
    </style>
    <div id="hdr">
      <strong>MIDI Player</strong>
      <span id="status" class="mo-chip" style="margin-left:auto;background:#444">idle</span>
    </div>
    <div id="drop">Drop MIDI files here (.mid)</div>
    <div class="mo-col" style="margin-top:8px">
      <label>Files</label>
      <select id="files" class="mo-input" size="4"></select>
    </div>
    <div class="mo-row" style="margin-top:8px">
      <button id="play" class="mo-btn">Play</button>
      <button id="pause" class="mo-btn">Pause</button>
      <button id="stop" class="mo-btn">Stop</button>
      <span class="mo-chip"><span id="cur">0:00</span> / <span id="dur">0:00</span></span>
    </div>
    <div class="mo-row" style="margin-top:8px">
      <input id="seek" type="range" min="0" max="1000" value="0">
    </div>
    <div class="mo-row" style="margin-top:8px">
      <label>Tempo</label>
      <input id="tempo" type="range" min="25" max="400" value="100">
      <span id="tempoVal" class="mo-chip">1.00\xD7</span>
      <label style="margin-left:12px">Transpose</label>
      <input id="transpose" type="range" min="-24" max="24" value="0">
      <span id="transVal" class="mo-chip">0</span>
    </div>
`;let e=t.querySelector("#hdr");$(t,e,"player"),document.body.appendChild(t),B(t,e);let n=t.querySelector("#drop"),o=t.querySelector("#files"),r=t.querySelector("#status"),s=t.querySelector("#play"),a=t.querySelector("#pause"),p=t.querySelector("#stop"),i=t.querySelector("#cur"),u=t.querySelector("#dur"),l=t.querySelector("#seek"),d=t.querySelector("#tempo"),f=t.querySelector("#tempoVal"),y=t.querySelector("#transpose"),h=t.querySelector("#transVal"),m=me(),x=0,w=null;function M(g){g=Math.max(0,g|0);let A=Math.floor(g/60),O=g%60;return`${A}:${O.toString().padStart(2,"0")}`}function S(g,A){r.textContent=g,r.style.background=A?"#264a2f":"#444"}function _(){w&&cancelAnimationFrame(w);let g=()=>{let A=Math.max(0,m.duration()),O=Math.max(0,Math.min(A,m.currentTime()));i.textContent=M(Math.round(O)),u.textContent=M(Math.round(A)),l._dragging||(l.value=String(A?Math.round(O/A*1e3):0)),w=requestAnimationFrame(g)};w=requestAnimationFrame(g)}let q=new Map;t.addEventListener("dragover",g=>{g.preventDefault()}),n.addEventListener("dragover",g=>{g.preventDefault(),n.classList.add("drag")}),n.addEventListener("dragleave",()=>n.classList.remove("drag")),n.addEventListener("drop",g=>{g.preventDefault(),n.classList.remove("drag");let A=g.dataTransfer?.files;if(!(!A||!A.length))for(let O of A){if(!/\.mid(i)?$/i.test(O.name))continue;let N=new FileReader;N.onload=()=>{q.set(O.name,N.result);let F=document.createElement("option");F.value=O.name,F.textContent=O.name,o.appendChild(F),S("loaded",!0)},N.readAsArrayBuffer(O)}});function b(){let g=o.value,A=q.get(g);if(!A){S("no file",!1);return}try{let O=m.loadBuffer(A);x=m.duration(),u.textContent=M(Math.round(x)),l.value="0",S("ready",!0)}catch(O){console.error(O),S("parse error",!1)}}o.addEventListener("change",b),s.addEventListener("click",()=>{if(!q.size){S("drop a file",!1);return}o.value||(o.selectedIndex=0,b()),m.play(),S("playing",!0)}),a.addEventListener("click",()=>{m.pause(),S("paused",!1)}),p.addEventListener("click",()=>{m.stop(),S("stopped",!1)}),l.addEventListener("input",()=>{let g=parseInt(l.value,10)/1e3*(x||0);l.addEventListener("mousedown",()=>l._dragging=!0),l.addEventListener("mouseup",()=>l._dragging=!1),l.addEventListener("touchstart",()=>l._dragging=!0,{passive:!0}),l.addEventListener("touchend",()=>l._dragging=!1,{passive:!0}),m.seek(g),i.textContent=M(Math.round(g)),c._lastPlayTime=g}),d.addEventListener("input",()=>{let g=parseInt(d.value,10)/100;m.setTempoMul(g),f.textContent=g.toFixed(2)+"\xD7"}),y.addEventListener("input",()=>{let g=parseInt(y.value,10)|0;m.setTranspose(g),h.textContent=String(g)}),_()}var T=document.createElement("div");Object.assign(T.style,{position:"fixed",left:"12px",bottom:"12px",zIndex:999999,background:"rgba(17,17,17,.95)",color:"#eee",padding:"10px",borderRadius:"10px",fontFamily:"system-ui",minWidth:"320px",boxShadow:"0 10px 30px rgba(0,0,0,.6)"});T.innerHTML=`
  <style>
    .mo-btn{background:#2b2b2b;color:#eee;border:1px solid #444;padding:6px 10px;border-radius:8px}
    .mo-btn:hover{background:#353535}
    .mo-chip{background:#1b1b1b;padding:3px 8px;border-radius:10px}
  </style>
  <div id="hdr" style="display:flex;align-items:center;gap:8px;cursor:move">
    <strong>MIDI Output</strong>
    <span id="st" class="mo-chip" style="margin-left:auto;background:#444">idle</span>
  </div>
  <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
    <button id="req" class="mo-btn">Request MIDI</button>
    <button id="rescan" class="mo-btn">Rescan</button>
    <select id="sel" style="flex:1;min-width:160px;background:#1b1b1b;color:#eee;border:1px solid #333;border-radius:8px;padding:6px"></select>
    <button id="test" class="mo-btn">Test</button>
  </div>
`;document.body.appendChild(T);var Ht=T.querySelector("#hdr")||T.firstElementChild;$(T,Ht,"midi-out");B(T,Ht);var Wt=T.querySelector("#st"),fe=T.querySelector("#req"),he=T.querySelector("#rescan"),L=T.querySelector("#sel"),st=T.querySelector("#test");function j(t,e){Wt.textContent=t,Wt.style.background=e?"#264a2f":"#742626"}function at(){L.innerHTML="";let t=ut();if(t.length===0){let n=document.createElement("option");n.value="",n.textContent="(no MIDI outputs)",L.appendChild(n),L.disabled=!0,st.disabled=!0;return}L.disabled=!1,t.forEach(n=>{let o=document.createElement("option");o.value=n.id,o.textContent=Z(n),L.appendChild(o)});let e=t[0];L.value=e.id,X(e.id),st.disabled=!1,j("\u2192 "+Z(e),!0)}fe.onclick=()=>{dt(at).then(()=>{j("ready",!0),at()}).catch(()=>j("WebMIDI unsupported",!1))};he.onclick=at;L.onchange=()=>{X(L.value);let t=L.options[L.selectedIndex]?.textContent||"(none)";j("\u2192 "+t,!0)};st.onclick=async()=>{try{let t=c.midi.out;if(!t){j("no output",!1);return}await t.open();let e=[60,64,67];for(let n=0;n<e.length;n++)t.send([144,e[n]&127,100]),setTimeout(()=>t.send([128,e[n]&127,0]),200+n*10),await new Promise(o=>setTimeout(o,180));j("test ok",!0)}catch(t){j("test failed",!1),console.warn(t)}};try{yt()}catch(t){console.warn("recorder-ui failed",t)}try{Rt()}catch(t){console.warn("monitor-ui failed",t)}try{xt()}catch(t){console.warn("sniffer failed",t)}try{zt()}catch(t){console.warn("player-ui failed",t)}})();
