(()=>{var f={record:!1,path:"\u2014",stats:{frames:0,pb:0,taps:0},players:new Map,dedupe:new Set,midi:{access:null,out:null}};function Q(t){let e=f.players.get(t);return e||(e={t0:null,recStart:null,events:[],active:new Map,seen:0,last:0,analysis:null,accomp:{enabled:!1,role:"bass",prevNote:null,prevDeg:null,refrac:0,active:new Set,tempo:110,rhythm:{swing:.54,grid8:Array(8).fill(0)}},model:{degLog:[],maxLog:64,ngram:new Map,pcCooldown:new Array(12).fill(0)},vis:{pcw:new Array(12).fill(0),lastOuts:[],lastDeg:null,planned:[]}},f.players.set(t,e),e)}function L(t,e){let n=0,o=0,r=0,s=0,a=!1,u=i=>{let c=i.touches?i.touches[0]:i;a=!0,n=c.clientX,o=c.clientY;let x=t.getBoundingClientRect();r=x.left,s=x.top,document.addEventListener("mousemove",l,{passive:!1}),document.addEventListener("mouseup",h,{passive:!1}),document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("touchend",h,{passive:!1}),i.preventDefault()},l=i=>{if(!a)return;let c=i.touches?i.touches[0]:i,x=r+(c.clientX-n),v=s+(c.clientY-o);Object.assign(t.style,{left:Math.max(8,Math.min(window.innerWidth-80,x))+"px",top:Math.max(8,Math.min(window.innerHeight-60,v))+"px",right:"auto",bottom:"auto"}),i.preventDefault()},h=()=>{a=!1,document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",h),document.removeEventListener("touchmove",l),document.removeEventListener("touchend",h)};e.style.cursor="move",e.addEventListener("mousedown",u,{passive:!1}),e.addEventListener("touchstart",u,{passive:!1})}function q(t,e,n){if(!t||!e)return;let o=document.createElement("button");o.type="button",o.title="Minimize",o.setAttribute("aria-label","Minimize panel"),o.textContent="\u2013",o.style.cssText="margin-left:8px;background:#2b2b2b;color:#eee;border:1px solid #444;padding:4px 8px;border-radius:8px;cursor:pointer";let r=t.querySelector(":scope > .__body");if(!r){r=document.createElement("div"),r.className="__body";let l=[],h=e.nextSibling;for(;h;){let i=h.nextSibling;l.push(h),h=i}l.forEach(i=>r.appendChild(i)),t.appendChild(r)}let s="mo:min:"+n;function a(l){r.style.display=l?"none":"",o.textContent=l?"+":"\u2013";try{localStorage.setItem(s,l?"1":"0")}catch{}}let u=!1;try{u=localStorage.getItem(s)==="1"}catch{}return a(u),o.addEventListener("click",()=>a(r.style.display!=="none")),e.appendChild(o),{button:o}}var N=(t,e,n)=>t<e?e:t>n?n:t;var C=()=>Date.now();function ct(t){let e=[],n=t&127;for(e.unshift(n);t>>=7;)n=t&127|128,e.unshift(n);return e}var lt=t=>Array.from(new TextEncoder().encode(String(t||""))),ut=t=>Math.max(0,Math.round(t/1e3*(480*2)));function G(t,e){if(!t.length)return null;let n={on:0,cc:1,off:2},o=t.slice().sort((c,x)=>c.t===x.t?n[c.type]-n[x.type]:c.t-x.t),r=[],s=c=>{let x=ct(c);for(let v=0;v<x.length;v++)r.push(x[v])},a=(c,x,v)=>{s(c),r.push(255,x,v.length,...v)};a(0,3,lt(e||"player")),a(0,81,[7,161,32]);let u=0;for(let c of o){let x=ut(c.t),v=Math.max(0,x-u);u=x,s(v),c.type==="on"?r.push(144,c.note&127,N(Math.round((c.vel??1)*127),1,127)):c.type==="off"?r.push(128,c.note&127,0):c.type==="cc"&&r.push(176,(c.cc|0)&127,N(c.val|0,0,127))}s(0),r.push(255,47,0);let l=r.length,h=[77,84,114,107,l>>>24&255,l>>>16&255,l>>>8&255,l&255],i=[77,84,104,100,0,0,0,6,0,0,0,1,1,224];return new Blob([new Uint8Array(i),new Uint8Array(h),new Uint8Array(r)],{type:"audio/midi"})}function J(t,e){let n=document.createElement("a");n.href=URL.createObjectURL(t),n.download=e,document.body.appendChild(n),n.click(),setTimeout(()=>{URL.revokeObjectURL(n.href),n.remove()},2e3)}function Y(t){return navigator.requestMIDIAccess?navigator.requestMIDIAccess({sysex:!1}).then(e=>(f.midi.access=e,e.onstatechange=()=>t&&t(),e)):Promise.reject(new Error("no-webmidi"))}function K(){let t=[],e=f.midi.access;if(!e)return t;try{e.outputs.forEach(n=>t.push(n))}catch{let n=e.outputs&&e.outputs.values&&e.outputs.values();if(n)for(let o of n)t.push(o)}return t}function R(t){let e=f.midi.access;if(!e)return null;let n=e.outputs.get?e.outputs.get(t):null;if(!n)try{e.outputs.forEach(o=>{o.id===t&&(n=o)})}catch{}return f.midi.out=n||null,f.midi.out}function j(t){return t?(t.manufacturer?t.manufacturer+" ":"")+(t.name||t.id||"(unnamed)"):"(none)"}function X(t){let e=f.midi.out;e&&e.send([128,(t|0)&127,0])}function Z(){let t=f.midi.out;if(t)for(let e=0;e<128;e++)t.send([128,e&127,0])}function tt(t){let e=f.midi.out;e&&e.send([176,64,t?127:0])}var et=typeof TextDecoder<"u"?new TextDecoder:null,pt=(t,e)=>{for(let n of e)if(Array.isArray(t?.[n]))return t[n];return null},F=t=>t.playerId??t.player??t.pid??t.id,T=t=>pt(t,["events","evts","e"]);function dt(t){let e=[],n=0;for(;n<t.length;){if(t.charAt(n)==="4"&&t.charAt(n+1)==="2"){let o=n+2;for(;o<t.length&&t.charAt(o)!=="[";)o++;if(o>=t.length)break;let r=0,s=o;for(;s<t.length;s++){let a=t.charAt(s);if(a==="[")r++;else if(a==="]"&&(r--,r===0)){s++;break}}try{e.push(JSON.parse(t.slice(o,s)))}catch{}n=s;continue}n++}return e}function P(t){let e=[];try{if(Array.isArray(t)){if(t[0]==="pianoBatch"){let n=t[1];if(Array.isArray(n))n.forEach(o=>{let r=F(o),s=T(o);r&&s&&e.push({playerId:r,events:s,t:o.t??o.ts??o.tISO??null})});else if(n&&typeof n=="object"){let o=F(n),r=T(n);o&&r&&e.push({playerId:o,events:r,t:n.t??n.ts??n.tISO??null})}}}else if(t&&typeof t=="object"){let n=F(t),o=T(t);if(n&&o)return e.push({playerId:n,events:o,t:t.t??t.ts??t.tISO??null}),e;let r=t.type||t.evt||t.op||t.event,s=t.payload??t.data;if(r==="pianoBatch"){if(Array.isArray(s))s.forEach(a=>{let u=F(a),l=T(a);u&&l&&e.push({playerId:u,events:l,t:a.t??a.ts??a.tISO??null})});else if(s&&typeof s=="object"){let a=F(s),u=T(s);a&&u&&e.push({playerId:a,events:u,t:s.t??s.ts??s.tISO??null})}}else{let a=F(t),u=T(t);a&&u&&e.push({playerId:a,events:u,t:t.t??t.ts??t.tISO??null})}}}catch{}return e}function ft(t){let e=[];if(!Array.isArray(t))return e;for(let n of t){let o=String(n.name||n.n||"").toUpperCase(),r=(n.timestamp??n.ts??n.time??n.tms??0)|0;if(o==="SUSTAIN"||o.includes("SUSTAIN")||n.cc===64||n.control===64){let s=n.value??n.v??n.val,a;n.sustain===!0?a=127:n.sustain===!1?a=0:Number.isFinite(s)?a=Math.max(0,Math.min(127,s|0)):a=0,e.push({type:"cc",cc:64,val:a,ts:r});continue}if(o==="NOTE_ON"||o==="ON"||n.on===1||n.down===!0){let s=(n.note??n.n??n.k??n.key)|0;if(s<0||s>127)continue;let a=((n.velocity??n.v??n.vel??127)|0)/127;e.push({type:"on",note:s,vel:a,ts:r});continue}if(o==="NOTE_OFF"||o==="OFF"||n.off===1||n.up===!0){let s=(n.note??n.n??n.k??n.key)|0;if(s<0||s>127)continue;e.push({type:"off",note:s,ts:r});continue}}return e}function mt(t){let e=Array.isArray(t.events)?t.events:[],n=1/0,o=-1/0;for(let a of e){let u=(a.timestamp??a.ts??a.tms??a.time??0)|0;u<n&&(n=u),u>o&&(o=u)}let r=t.playerId??t.player??t.pid??t.id??"?",s=e.length|0;return`${r}|${t.t||t.ts||t.tISO||"?"}|${s}|${n}-${o}`}function yt(t,e,n,o){t.t0==null&&(t.t0=e),f.record&&t.recStart==null&&(t.recStart=e);let r=t.recStart??t.t0,s=Math.max(0,e-r);if(t.active.has(n)){let a=Math.max(0,s-.1);t.events.push({t:a,type:"off",note:n,vel:0})}t.active.set(n,{tOn:s,vel:o}),t.events.push({t:s,type:"on",note:n,vel:o})}function ht(t,e,n){t.t0==null&&(t.t0=e);let o=t.recStart??t.t0,r=Math.max(0,e-o);t.active.has(n)&&t.active.delete(n),t.events.push({t:r,type:"off",note:n,vel:0})}function U(t){if(f.stats.frames++,typeof t=="string"){let e=dt(t);if(e.length){for(let o of e){let r=P(o);for(let s of r)$(s,"WS")}return}try{let o=JSON.parse(t),r=Array.isArray(o)?o:[o];for(let s of r){let a=P(s);for(let u of a)$(u,"WS")}return}catch{}let n=t.split(/\r?\n/).map(o=>o.trim()).filter(Boolean);for(let o of n)try{let r=JSON.parse(o),s=P(r);for(let a of s)$(a,"WS")}catch{}return}if(t instanceof ArrayBuffer){if(et)try{let e=et.decode(new Uint8Array(t));e&&U(e)}catch{}return}if(typeof Blob<"u"&&t instanceof Blob){let e=new FileReader;e.onload=function(){U(String(e.result||""))};try{e.readAsText(t.slice(0,16384))}catch{}}}function $(t,e){f.path=e||f.path;let n=mt(t);if(f.dedupe.has(n))return;f.dedupe.add(n);let o=String(t.playerId??t.player??t.pid??t.id??"unknown"),r=Q(o),s=ft(t.events);if(!s.length)return;let a=t.t!=null?t.t:null,u=s[0].ts;for(let l of s){let h=a!=null?a-u+l.ts:C()+(l.ts-u);if(l.type==="cc"&&l.cc===64){r.t0==null&&(r.t0=h),f.record&&r.recStart==null&&(r.recStart=h);let i=r.recStart??r.t0,c=Math.max(0,h-i);r.events.push({t:c,type:"cc",cc:64,val:l.val|0});continue}if(l.type==="on"){yt(r,h,l.note,l.vel);continue}if(l.type==="off"){ht(r,h,l.note);continue}}r.seen+=s.length,r.last=C(),f.stats.pb++}function nt(){let t=window.WebSocket;if(t){if(!t.prototype.__mo_hooked__){let e=t.prototype.addEventListener;t.prototype.addEventListener=function(r,s,a){if(r==="message"&&typeof s=="function"){let u=l=>{try{f.stats.taps++,U(l.data)}catch{}return s.call(this,l)};return e.call(this,r,u,a)}return e.call(this,r,s,a)};let n=Object.getOwnPropertyDescriptor(t.prototype,"onmessage")||{};Object.defineProperty(t.prototype,"onmessage",{configurable:!0,enumerable:!0,get:n.get?n.get:function(){return this.__mo_on__||null},set:function(r){if(typeof r=="function"){let s=a=>{try{f.stats.taps++,U(a.data)}catch{}return r.call(this,a)};this.__mo_on__=s,this.addEventListener("message",s)}else this.__mo_on__=null}});let o=t.prototype.send;t.prototype.send=function(){try{this.__mo_attached__||(this.addEventListener("message",r=>{try{f.stats.taps++,U(r.data)}catch{}}),Object.defineProperty(this,"__mo_attached__",{value:!0}))}catch{}return o.apply(this,arguments)},Object.defineProperty(t.prototype,"__mo_hooked__",{value:!0})}if(!window.__mo_ws_ctor__){let e=function(n,o){let r=o!==void 0?new t(n,o):new t(n);try{r.addEventListener("message",s=>{try{f.stats.taps++,U(s.data)}catch{}}),Object.defineProperty(r,"__mo_attached__",{value:!0})}catch{}return r};e.prototype=t.prototype,Object.setPrototypeOf(e,t),window.WebSocket=e,Object.defineProperty(window,"__mo_ws_ctor__",{value:!0})}}}function ot(){let t=document.createElement("div");Object.assign(t.style,{position:"fixed",right:"12px",top:"12px",zIndex:999999,minWidth:"420px",color:"#eee",fontFamily:"system-ui",background:"rgba(17,17,17,.95)",borderRadius:"10px",boxShadow:"0 10px 30px rgba(0,0,0,.6)",maxHeight:"70vh",overflow:"hidden"}),t.innerHTML=`
    <style>
      .mo-btn{background:#2b2b2b;color:#eee;border:1px solid #444;padding:6px 10px;border-radius:8px;user-select:none}
      .mo-btn:hover{background:#353535}
      .mo-chip{background:#1b1b1b;padding:3px 8px;border-radius:10px}
      .row{display:flex;gap:8px;align-items:center;margin-bottom:6px;flex-wrap:wrap;min-height:34px}
      .row-live{outline:2px solid #1a915e;border-radius:10px;background:linear-gradient(90deg, rgba(26,145,94,0.12), transparent)}
    </style>
    <div id="hdr" style="display:flex;align-items:center;gap:8px;user-select:none;cursor:move">
      <strong>Room Recorder</strong>
      <span id="st" class="mo-chip" style="margin-left:auto;background:#264a2f">live</span>
    </div>
    <div style="display:flex;gap:6px;margin-top:8px;align-items:center;flex-wrap:wrap">
      <button id="expAll" class="mo-btn">Export all</button>
      <button id="clear" class="mo-btn">Clear</button>
    </div>
    <div style="margin-top:6px;font-size:12px;opacity:.85">
      frames:<b id="f">0</b> \u2022 pb:<b id="pb">0</b> \u2022 taps:<b id="t">0</b> \u2022 path:<b id="path">\u2014</b>
    </div>
    <div id="players" style="margin-top:8px;border:1px solid #333;border-radius:8px;padding:6px;max-height:48vh;overflow:auto;font-size:12px"></div>
  `,document.body.appendChild(t);let e=t.querySelector("#hdr")||t.firstElementChild;q(t,e,"recorder"),L(t,e);let n=t.querySelector("#expAll"),o=t.querySelector("#clear"),r=t.querySelector("#f"),s=t.querySelector("#pb"),a=t.querySelector("#t"),u=t.querySelector("#path"),l=t.querySelector("#players"),h=new Map;function i(){r.textContent=String(f.stats.frames),s.textContent=String(f.stats.pb),a.textContent=String(f.stats.taps),u.textContent=f.path}function c(g){let y=h.get(g);if(y)return y;let m=document.createElement("div");m.className="row",m.setAttribute("data-id",g),m.innerHTML=`
      <code style="background:#111;padding:2px 6px;border-radius:6px">${g}</code>
      <span class="seen">seen:0</span>
      <span class="ev">\u2022 ev:0</span>
      <span class="act">\u2022 act:0</span>
      <span class="last">\u2022 last:\u2014s</span>
      <span class="an mo-chip" style="margin-left:auto;opacity:.9">\u2014</span>
      <div class="btns" style="display:flex;gap:6px;margin-left:auto">
        <button class="mo-btn save">Export</button>
        <button class="mo-btn reset">Reset</button>
      </div>`;let b={row:m,seen:m.querySelector(".seen"),ev:m.querySelector(".ev"),act:m.querySelector(".act"),last:m.querySelector(".last"),an:m.querySelector(".an"),save:m.querySelector(".save"),reset:m.querySelector(".reset")};return l.appendChild(m),h.set(g,b),b.save.onclick=()=>v(g),b.reset.onclick=()=>{let w=f.players.get(g);w&&(w.events.length=0,w.active.forEach((k,I)=>X(I)),w.active.clear(),w._lastOnIdx=0,w.vis.lastOuts=[],x(g,w))},b}function x(g,y){let m=c(g);m.seen.textContent=`seen:${y.seen}`,m.ev.textContent=`\u2022 ev:${y.events.length}`,m.act.textContent=`\u2022 act:${y.active.size}`,m.last.textContent=`\u2022 last:${y.last?((C()-y.last)/1e3).toFixed(1)+"s":"\u2014s"}`;let b="\u2014";if(y.analysis){let{bpm:w,swing:k,scale:I,rootPc:O}=y.analysis;b=`${Math.round(w)}bpm \u2022 sw:${k.toFixed(2)} \u2022 key:${I}/${O}`}m.an.textContent=b,m.row.classList.toggle("row-live",C()-y.last<800)}function v(g){let y=f.players.get(g);if(!y||!y.events.length)return;let m=G(y.events);J(m,`player-${g}-${Date.now()}.mid`)}return n.onclick=()=>{f.players.forEach((g,y)=>v(y))},o.onclick=()=>{tt(!1),Z(),f.players.clear(),f.dedupe.clear(),l.innerHTML="",h.clear()},setInterval(()=>{f.players.forEach((g,y)=>x(y,g)),n.disabled=[...f.players.values()].every(g=>!g.events.length&&!g.active.size),i()},400),{box:t}}function W(t,e){return t.getUint8(e)<<8|t.getUint8(e+1)}function rt(t,e){return t.getUint8(e)<<24|t.getUint8(e+1)<<16|t.getUint8(e+2)<<8|t.getUint8(e+3)}function z(t,e){let n=0,o=e,r;do r=t.getUint8(o++),n=n<<7|r&127;while(r&128);return{val:n,len:o-e}}function xt(t){let e=new DataView(t);if(String.fromCharCode(e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3))!=="MThd")throw new Error("Invalid MIDI");let n=rt(e,4),o=W(e,8),r=W(e,10),s=W(e,12),a=8+n,u=[];for(let l=0;l<r;l++){if(String.fromCharCode(e.getUint8(a),e.getUint8(a+1),e.getUint8(a+2),e.getUint8(a+3))!=="MTrk")throw new Error("Bad track");let h=rt(e,a+4),i=a+8+h,c=a+8,x=0,v=0,g=[];for(;c<i;){let y=z(e,c);c+=y.len,v+=y.val;let m=e.getUint8(c++);if(m&128?x=m:(c--,m=x),m===255){let b=e.getUint8(c++),w=z(e,c);c+=w.len;let k=new Uint8Array(t,c,w.val);c+=w.val,g.push({tick:v,type:"meta",meta:b,data:k})}else if(m===240||m===247){let b=z(e,c);c+=b.len+b.val}else{let b=m&240,w=m&15,k=e.getUint8(c++),I=b===192||b===208?0:e.getUint8(c++);g.push({tick:v,type:b,ch:w,a:k,b:I})}}u.push(g),a=i}return{format:o,division:s,tracks:u}}function gt(t){let e=[];for(let i of t.tracks)for(let c of i)e.push(c);e.sort((i,c)=>i.tick-c.tick);let n=5e5,o=[];for(let i of e)i.type==="meta"&&i.meta===81&&i.data&&i.data.length===3?(n=i.data[0]<<16|i.data[1]<<8|i.data[2],o.push({kind:"tempo",tick:i.tick,tempo:n})):typeof i.type=="number"&&o.push({kind:"midi",tick:i.tick,type:i.type,ch:i.ch,a:i.a,b:i.b});let r=t.division&32767,s=0,a=5e5,u=0,l=[],h=0;for(;h<o.length;){let i=o[h],c=i.tick-s;u+=c*(a/1e6)/r,s=i.tick,i.kind==="tempo"?a=i.tempo:l.push({...i,time:u}),h++}return l}function bt(){let t=[],e=!1,n=0,o=0,r=1,s=0,a=0,u=null,l=new Map;function h(){return f.midi.out}function i(){return performance.now()/1e3}function c(d){let p=h();if(p)if(d.type===144)p.send([144|d.ch,d.a+s&127,d.b]),l.set(d.ch<<8|d.a,[d.a+s&127,d.ch]);else if(d.type===128){let S=d.ch<<8|d.a,M=l.get(S)||[d.a+s&127,d.ch];p.send([128|M[1],M[0],0]),l.delete(S)}else d.type===176?p.send([176|d.ch,d.a,d.b]):d.type===192?p.send([192|d.ch,d.a]):d.type===224&&p.send([224|d.ch,d.a,d.b])}function x(){let d=h();if(d)for(let p=0;p<16;p++)d.send([176|p,64,0]),d.send([176|p,123,0]),d.send([176|p,120,0])}function v(d){e=!1,u&&cancelAnimationFrame(u),x(),o=Math.max(0,Math.min(d,g())),a=t.findIndex(p=>p.time>=o),a<0&&(a=t.length)}function g(){return t.length?t[t.length-1].time:0}function y(d){r=Math.max(.25,Math.min(4,d||1))}function m(d){s=Math.max(-36,Math.min(36,d|0))}function b(){if(!e)return;let d=(i()-n)*r+o;for(;a<t.length&&t[a].time<=d;)c(t[a++]);if(a>=t.length){e=!1,x();return}u=requestAnimationFrame(b)}function w(){e||(e=!0,n=i(),u=requestAnimationFrame(b))}function k(){if(!e)return;let d=(i()-n)*r+o;e=!1,u&&cancelAnimationFrame(u),o=d,x()}function I(){e=!1,u&&cancelAnimationFrame(u),o=0,a=0,x()}function O(d){let p=xt(d);return t=gt(p),o=0,a=0,{duration:g()}}return{play:w,pause:k,stop:I,seek:v,setTempoMul:y,setTranspose:m,loadBuffer:O,duration:g,isPlaying:()=>e,currentTime:()=>e?(performance.now()/1e3-n)*r+o:o}}function st(){let t=document.createElement("div");Object.assign(t.style,{position:"fixed",left:"12px",top:"12px",zIndex:999999,background:"rgba(17,17,17,.95)",color:"#eee",padding:"10px",borderRadius:"10px",fontFamily:"system-ui",minWidth:"420px",maxWidth:"520px",boxShadow:"0 10px 30px rgba(0,0,0,.6)"}),t.innerHTML=`
    <style>
      .mo-btn{background:#2b2b2b;color:#eee;border:1px solid #444;padding:6px 10px;border-radius:8px;user-select:none;cursor:pointer}
      .mo-btn:hover{background:#353535}
      .mo-chip{background:#1b1b1b;padding:3px 8px;border-radius:10px}
      .mo-input{background:#1b1b1b;color:#eee;border:1px solid #333;border-radius:8px;padding:6px}
      .mo-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
      .mo-col{display:flex;flex-direction:column;gap:4px}
      #drop{border:1px dashed #555;padding:12px;border-radius:8px;text-align:center;opacity:.9}
      #drop.drag{background:#202020}
      #filelist{max-height:140px;overflow:auto;border:1px solid #333;border-radius:8px;padding:6px}
      #seek{width:100%}
      #hdr{display:flex;align-items:center;gap:8px;user-select:none}
    </style>
    <div id="hdr">
      <strong>MIDI Player</strong>
      <span id="status" class="mo-chip" style="margin-left:auto;background:#444">idle</span>
    </div>
    <div id="drop">Drop MIDI files here (.mid)</div>
    <div class="mo-col" style="margin-top:8px">
      <label>Files</label>
      <select id="files" class="mo-input" size="4"></select>
    </div>
    <div class="mo-row" style="margin-top:8px">
      <button id="play" class="mo-btn">Play</button>
      <button id="pause" class="mo-btn">Pause</button>
      <button id="stop" class="mo-btn">Stop</button>
      <span class="mo-chip"><span id="cur">0:00</span> / <span id="dur">0:00</span></span>
    </div>
    <div class="mo-row" style="margin-top:8px">
      <input id="seek" type="range" min="0" max="1000" value="0">
    </div>
    <div class="mo-row" style="margin-top:8px">
      <label>Tempo</label>
      <input id="tempo" type="range" min="25" max="400" value="100">
      <span id="tempoVal" class="mo-chip">1.00\xD7</span>
      <label style="margin-left:12px">Transpose</label>
      <input id="transpose" type="range" min="-24" max="24" value="0">
      <span id="transVal" class="mo-chip">0</span>
    </div>
`;let e=t.querySelector("#hdr");q(t,e,"player"),document.body.appendChild(t),L(t,e);let n=t.querySelector("#drop"),o=t.querySelector("#files"),r=t.querySelector("#status"),s=t.querySelector("#play"),a=t.querySelector("#pause"),u=t.querySelector("#stop"),l=t.querySelector("#cur"),h=t.querySelector("#dur"),i=t.querySelector("#seek"),c=t.querySelector("#tempo"),x=t.querySelector("#tempoVal"),v=t.querySelector("#transpose"),g=t.querySelector("#transVal"),y=bt(),m=0,b=null;function w(p){p=Math.max(0,p|0);let S=Math.floor(p/60),M=p%60;return`${S}:${M.toString().padStart(2,"0")}`}function k(p,S){r.textContent=p,r.style.background=S?"#264a2f":"#444"}function I(){b&&cancelAnimationFrame(b);let p=()=>{let S=Math.max(0,y.duration()),M=Math.max(0,Math.min(S,y.currentTime()));l.textContent=w(Math.round(M)),h.textContent=w(Math.round(S)),i._dragging||(i.value=String(S?Math.round(M/S*1e3):0)),b=requestAnimationFrame(p)};b=requestAnimationFrame(p)}let O=new Map;t.addEventListener("dragover",p=>{p.preventDefault()}),n.addEventListener("dragover",p=>{p.preventDefault(),n.classList.add("drag")}),n.addEventListener("dragleave",()=>n.classList.remove("drag")),n.addEventListener("drop",p=>{p.preventDefault(),n.classList.remove("drag");let S=p.dataTransfer?.files;if(!(!S||!S.length))for(let M of S){if(!/\.mid(i)?$/i.test(M.name))continue;let D=new FileReader;D.onload=()=>{O.set(M.name,D.result);let B=document.createElement("option");B.value=M.name,B.textContent=M.name,o.appendChild(B),k("loaded",!0)},D.readAsArrayBuffer(M)}});function d(){let p=o.value,S=O.get(p);if(!S){k("no file",!1);return}try{let M=y.loadBuffer(S);m=y.duration(),h.textContent=w(Math.round(m)),i.value="0",k("ready",!0)}catch(M){console.error(M),k("parse error",!1)}}o.addEventListener("change",d),s.addEventListener("click",()=>{if(!O.size){k("drop a file",!1);return}o.value||(o.selectedIndex=0,d()),y.play(),k("playing",!0)}),a.addEventListener("click",()=>{y.pause(),k("paused",!1)}),u.addEventListener("click",()=>{y.stop(),k("stopped",!1)}),i.addEventListener("input",()=>{let p=parseInt(i.value,10)/1e3*(m||0);i.addEventListener("mousedown",()=>i._dragging=!0),i.addEventListener("mouseup",()=>i._dragging=!1),i.addEventListener("touchstart",()=>i._dragging=!0,{passive:!0}),i.addEventListener("touchend",()=>i._dragging=!1,{passive:!0}),y.seek(p),l.textContent=w(Math.round(p)),f._lastPlayTime=p}),c.addEventListener("input",()=>{let p=parseInt(c.value,10)/100;y.setTempoMul(p),x.textContent=p.toFixed(2)+"\xD7"}),v.addEventListener("input",()=>{let p=parseInt(v.value,10)|0;y.setTranspose(p),g.textContent=String(p)}),I()}var _=document.createElement("div");Object.assign(_.style,{position:"fixed",left:"12px",bottom:"12px",zIndex:999999,background:"rgba(17,17,17,.95)",color:"#eee",padding:"10px",borderRadius:"10px",fontFamily:"system-ui",minWidth:"320px",boxShadow:"0 10px 30px rgba(0,0,0,.6)"});_.innerHTML=`
  <style>
    .mo-btn{background:#2b2b2b;color:#eee;border:1px solid #444;padding:6px 10px;border-radius:8px}
    .mo-btn:hover{background:#353535}
    .mo-chip{background:#1b1b1b;padding:3px 8px;border-radius:10px}
  </style>
  <div id="hdr" style="display:flex;align-items:center;gap:8px;cursor:move">
    <strong>MIDI Output</strong>
    <span id="st" class="mo-chip" style="margin-left:auto;background:#444">idle</span>
  </div>
  <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
    <button id="req" class="mo-btn">Request MIDI</button>
    <button id="rescan" class="mo-btn">Rescan</button>
    <select id="sel" style="flex:1;min-width:160px;background:#1b1b1b;color:#eee;border:1px solid #333;border-radius:8px;padding:6px"></select>
    <button id="test" class="mo-btn">Test</button>
  </div>
`;document.body.appendChild(_);var it=_.querySelector("#hdr")||_.firstElementChild;q(_,it,"midi-out");L(_,it);var at=_.querySelector("#st"),vt=_.querySelector("#req"),wt=_.querySelector("#rescan"),E=_.querySelector("#sel"),V=_.querySelector("#test");function A(t,e){at.textContent=t,at.style.background=e?"#264a2f":"#742626"}function H(){E.innerHTML="";let t=K();if(t.length===0){let n=document.createElement("option");n.value="",n.textContent="(no MIDI outputs)",E.appendChild(n),E.disabled=!0,V.disabled=!0;return}E.disabled=!1,t.forEach(n=>{let o=document.createElement("option");o.value=n.id,o.textContent=j(n),E.appendChild(o)});let e=t[0];E.value=e.id,R(e.id),V.disabled=!1,A("\u2192 "+j(e),!0)}vt.onclick=()=>{Y(H).then(()=>{A("ready",!0),H()}).catch(()=>A("WebMIDI unsupported",!1))};wt.onclick=H;E.onchange=()=>{R(E.value);let t=E.options[E.selectedIndex]?.textContent||"(none)";A("\u2192 "+t,!0)};V.onclick=async()=>{try{let t=f.midi.out;if(!t){A("no output",!1);return}await t.open();let e=[60,64,67];for(let n=0;n<e.length;n++)t.send([144,e[n]&127,100]),setTimeout(()=>t.send([128,e[n]&127,0]),200+n*10),await new Promise(o=>setTimeout(o,180));A("test ok",!0)}catch(t){A("test failed",!1),console.warn(t)}};try{ot()}catch(t){console.warn("recorder-ui failed",t)}try{nt()}catch(t){console.warn("sniffer failed",t)}try{st()}catch(t){console.warn("player-ui failed",t)}})();
